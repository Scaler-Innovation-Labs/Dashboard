name: Enforce Branch Rules

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main
      - staging
      - dev

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      # Rule: PRs to main must come only from staging
      - name: Validate PR into main
        if: github.base_ref == 'main' && github.head_ref != 'staging'
        run: |
          echo "::error::âŒ Invalid pull request."
          echo "Pull requests into 'main' are restricted."
          echo "âœ… Only PRs from 'staging' â†’ 'main' are allowed."
          exit 1

      # Rule: PRs to staging must come only from dev
      - name: Validate PR into staging
        if: github.base_ref == 'staging' && github.head_ref != 'dev'
        run: |
          echo "::error::âŒ Invalid pull request."
          echo "Pull requests into 'staging' are restricted."
          echo "âœ… Only PRs from 'dev' â†’ 'staging' are allowed."
          exit 1

      # Rule: PRs to dev must come from feature/* or bugfix/*
      - name: Validate PR into dev
        if: github.base_ref == 'dev' && startsWith(github.head_ref, 'feature/') == false && startsWith(github.head_ref, 'bugfix/') == false
        run: |
          echo "::error::âŒ Invalid pull request."
          echo "Pull requests into 'dev' must come from feature branches."
          echo "âœ… Allowed branch names: 'feature/*' or 'bugfix/*'."
          exit 1

      # Success Message
      - name: Success Message
        if: (github.base_ref == 'main' && github.head_ref == 'staging') || (github.base_ref == 'staging' && github.head_ref == 'dev') || (github.base_ref == 'dev' && (startsWith(github.head_ref, 'feature/') || startsWith(github.head_ref, 'bugfix/')))
        run: |
          echo "ğŸ‰ Branch validation successful!"
          echo "This PR follows the branching rules correctly."